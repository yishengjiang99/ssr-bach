<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/2.3.5/mini-dark.min.css"
      integrity="sha512-kTCeb2Zn9eKlrePwHZ5pe5gU2khy3gurd7YvVD44mgNkXcSPfqYHubC07jGwFND43cSxSz+oHP49V7SdUREcMg=="
      crossorigin="anonymous"
    />
    <script
      crossorigin
      src="https://unpkg.com/react@17/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="container">
    <div id="root"></div>
    <script type="module">
      import { SFGenerator } from './dist/generator.js';
      import { SFZone } from './dist/Zone.js';
      import { PDTA } from './dist/pdta.js';

      function readAB(arb) {
        const u8b = new Uint8Array(arb);
        let offset = 0;
        const get8 = () => {
          return u8b[offset++];
        };
        const getStr = (n) => {
          let str = '';
          let nullterm = 0;
          for (let i = 0; i < n; i++) {
            let c = get8();
            if (c == 0x00) nullterm = 1;
            if (nullterm == 0) str += String.fromCharCode(c);
          }
          return str;
        };
        const getUint32 = () =>
          get8() | (get8() << 8) | (get8() << 16) | (get8() << 24);
        const getU16 = () => get8() | (get8() << 8);
        const getS16 = () => {
          const u16 = getU16();
          if (u16 & 0x8000) return -0x10000 + u16;
          else return u16;
        };
        return {
          offset,

          skip: function (n) {
            offset = offset + n;
          },
          get8,
          get16: getU16,
          getS16,
          readN: (n) => {
            const ret = u8b.slice(offset, n);
            offset += n;
            return ret;
          },
          read32String: () => getStr(4),
          varLenInt: () => {
            let v = 0;
            let n = get8();
            v = n & 0x7f;
            while (n & 0x80) {
              n = get8();
              v = (v << 7) | (n & 0x7f);
            }
            return n;
          },
          get32: getUint32,

          readNString: (n) => getStr(n),
          getUint16: getU16,
        };
      }

      async function uint8sf2(ab) {
        const r = readAB(ab);
        const { readNString, get32, skip } = r;
        const [riff, filesize, sig, list] = [
          r.readNString(4),
          r.get32(),
          r.readNString(4),
          r.readNString(4),
        ];
        let infosize = get32();
        console.log(readNString(4), r.offset);

        console.log(infosize, r.offset);

        // while (infosize % 4 != 0) {
        //   // r.get8();
        //  // infosize++;
        // }
        r.skip(infosize - 4);
        console.log(readNString(4), r.offset);

        let sdtas = get32();
        console.log(readNString(4), r.offset);
        console.log(readNString(4), r.offset);
        const b16s = r.readN(sdtas - 4);

        console.log(get32());
        console.log(readNString(4));
        const pdta = new PDTA(r);
        const sfbk = {
          sdta: {
            bit16s: b16s,
            data: new Proxy(b16s, {
              get: (target, index) => {
                return target[index] / 0xffff;
              },
            }),
          },
          sdtastart: 1,
          sdtaByteLength: 2,
          pdta,
          runtime: function (presetId, key, vel = 70, bankId = 0) {
            const zones = this.pdta.findPreset(presetId, bankId, key, vel);
            if (!zones || zones.length == 0) return false;
            return this.pdta
              .findPreset(presetId, bankId, key, vel)
              .map((zone) => {
                const rt = new Runtime(
                  zone,
                  {
                    key,
                    velocity: vel,
                  },
                  48000
                );
                return rt;
              });
          },
        };
        return sfbk;
      }

      async function gheap(length, wasmbin) {
        const heap_start = 8;
        const wasm_page_size = 1024 * 56;
        const pages = Math.ceil((length / wasm_page_size) * 5 + 10240);
        const mem = new WebAssembly.Memory({
          initial: pages,
          maximum: pages,
        });
        const heap = new Uint8Array(mem.buffer);
        let offset = 8;
        const malloc = (n) => {
          while (offset % 8) offset++; // malign with 8 instead of 4 bc we gorilla 2step
          const ptr = offset;
          offset += n;
          return ptr;
        };
        let stackTop = heap.byteLength - 4;
        const allocStack = (n, cb) => {
          stackTop -= n;
          cb(stackTop);
          stackTop += n;
          return stackTop;
        };
        const config = {
          env: {
            memory: mem,

            table: new WebAssembly.Table({ initial: 0, element: 'anyfunc' }),
            _abort: () => console.log('abort?'),
            _grow: () => {
              console.log('grow?');
            },
            consolelog: (str, b) => console.log(str, b),
          },
        };
        const {
          instance: { exports },
        } = await WebAssembly.instantiate(wasmbin, config);
        const inputParams = malloc(4 + 4 + 4 + 4 + 4 + 4 + 4);

        return { heap, malloc, mem, allocStack, exports };
      }

      async function initsf(sfurl) {
        const bin = await (await fetch('sdta.wasm')).arrayBuffer();
        const arr = new Uint8Array(await (await fetch(sfurl)).arrayBuffer());
        const { pdta, sdta } = await uint8sf2(arr);
        const { heap, malloc, mem, allocStack, exports } = await gheap(
          arr.byteLength,
          bin
        );
        const nsamples = arr.byteLength / 2;

        const inputptr = malloc(arr.byteLength + 20);
        heap.set(arr, inputptr);

        const floffset = malloc(2 * arr.byteLength + 20);
        console.log(inputptr, floffset);
        // @ts-ignore
        exports['load'](inputptr, floffset, nsamples);
        const inputParams = malloc(4 + 4 + 4 + 4 + 4 + 4 + 4);
        const dv = new DataView(heap.buffer, inputParams, 28);
        const soundCard = malloc(10240);
        function render(
          { start, end, startLoop, endLoop },
          { pitch, amount, pan }
        ) {
          [iterator, startLoop, endLoop, blockLength].map((v, idx) =>
            dv.setUint32(idx * 4, v, true)
          );
          [pitch, volume * left, volume * right].map((v, idx) =>
            dv.setFloat32(16 + idx * 4, v, true)
          );
        }
        return { render, pdta, sdta };
      }
      window.loadSF2 = initsf;
      initsf('GeneralUserGS.sf2').then(window.onSFBKLoad);
    </script>
    <script id="workerTemplate" type="templat/worker">

      addEventListener("onMessage",function(e){
              console.log(e.message);
          });
    </script>
    <script type="text/babel">
      function Synth({ phdr, findPreset, preset, presetId }) {
        const [program, setProgram] = React.useState(presetId);
        const [presetDefault, setPresetDefault] = React.useState(null);
        const [instruments, setInstruments] = React.useState([]);

        const cb = React.useCallback(
          (presetId) => {
            const { presetDefault, zones } = findPreset(presetId);
            setInstruments(zones);
          },
          [presetId]
        );
        React.useEffect(() => {
          cb(program);
        }, [program]);

        return (
          <div>
            <select
              value={program}
              onChange={(e) => setProgram(e.target.value)}
            >
              {phdr.map((preset) => (
                <option value={preset.presetId}>{preset.name}</option>
              ))}
            </select>
            <table>
              {presetDefault && <Zone type={'baseline'} zone={presetDefault} />}
              {instruments &&
                instruments.map((i) => (
                  <React.Fragment>
                    <tr>
                      <td colSpan={5}>{i.inst.name}</td>
                    </tr>
                    {i.defaultBg && <Zone type="pbag" zone={i.defaultBg} />}
                    {i.izones && i.izones.map((iz) => <Zone zone={iz} />)}
                  </React.Fragment>
                ))}
            </table>
          </div>
        );
      }
      function log_to_linear(centtime) {
        //this is a non-generalized computation from weird 2^(1/1200)
        let t = 0;
        while (centime > -12000) {
          centtime;
        }
      }
      function Env({ env }) {
        const maxY = 24;
        const { delay, attack, hold, decay, release } = env.phases;
        let path = 'm 1 29';
        let x = 1;
        const ys = [0, -maxY, 0, (env.sustain / 1000) * maxY, maxY];
        for (const rate of [delay, attack, hold, decay, release]) {
          path += ` h ${(rate + 12000) / 420} v ${ys.shift()}`;
        }
        return (
          <svg height="30" width="100">
            <path fill="transparent" stroke="yellow" d={path}></path>
          </svg>
        );
      }
      function Zone({ zone, playSample, isLit }) {
        return (
          <tr>
            <td>
              {zone.velRange.lo}-{zone.velRange.hi}
            </td>
            <td>
              {zone.keyRange.lo}-{zone.keyRange.hi}
            </td>
            {'attenuate,pan,chorus,reverbsend'.split(',').map((att) => (
              <td>{zone[att]}</td>
            ))}
            <td>
              <Env env={zone.modEnv} />
            </td>{' '}
            <td>
              <Env env={zone.volEnv} />
            </td>
            <td>
              <button onClick={() => {}}>Play Sample</button>
            </td>
          </tr>
        );
      }
    </script>
    <script>
      const renderCtx = new Worker(
        URL.createObjectURL(
          new Blob([document.querySelector('#workerTemplate').textContent], {
            type: 'application/javascript',
          })
        ),
        { type: 'module' }
      );

      window.onSFBKLoad = function ({ pdta: { findPreset, phdr }, render }) {
        ReactDOM.render(
          React.createElement(
            React.Fragment,
            {},
            phdr.slice(0, 9).map((phr, channelId) =>
              React.createElement(
                Synth,
                {
                  key: channelId,
                  channelId,
                  phdr,
                  findPreset,
                  presetId: phr.presetId,
                },
                []
              )
            )
          ),
          document.querySelector('#root')
        );
      };
    </script>
  </body>
</html>
