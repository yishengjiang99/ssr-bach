<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title><span class="material-icons">face</span> Mocha</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./mini-dark.min.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <header class="sticky">
      <!-- This might seem a bight hacky but it works great -->
      <div class="col-sm col-lg-8 col-lg-offset-4">
        <button class="pcm" srcc="/node">Play</button>
        <select id="sfselect">
          <options>selectSF</options>
        </select>
        <select id="sfselect">
          <options>selectMidi</options>
        </select>
      </div>
    </header>
    <div class="container">
      <div id="root"></div>
    </div>
    <script type="module">
      import { start } from './js/dist/playpcm.js';
      let ctx, gainNode;
      async function playSample(url, cb) {
        try {
          debugger;
          if (!ctx) {
            ctx = new AudioContext({
              sampleRate: 48000,
              latencyHint: 'playback',
            });
            gainNode = new GainNode(ctx, { gain: 1 });
            gainNode.connect(ctx.destination);
          }

          const dv = await fetch(url)
            .then((resp, header) => {
              cb('resp got');

              return resp.arrayBuffer();
            })
            .then((ab) => new DataView(ab))
            .catch((e) => cb('error ' + e.message));

          if (!dv) return;
          const audb = ctx.createBuffer(2, dv.buffer.byteLength / 8, 48000);
          const buffers = [audb.getChannelData(0), audb.getChannelData(1)];
          for (let i = 0; i < audb.length; i++) {
            console.log(dv.getFloat32(i, true));
            buffers[0][i] = dv.getFloat32(i * 4, true);
            buffers[1][i] = dv.getFloat32(i * 4, true);
          }
          const abs = new AudioBufferSourceNode(ctx, { buffer: audb });
          abs.connect(gainNode);
          abs.start();
        } catch (e) {
          console.log("<font color='red'>" + e.message + '</font>');
          throw e;
        }
      }
    </script>
    <script type="text/babel">
      import { Runtime } from 'js/runtime.js';

      function ZoneUI({ zone, setPane2Txt }) {
        const [details, setDetails] = React.useState('');
        return (
          <div>
            {' '}
            {zone.shdr.name}
            <div className="light section">status:{details}</div>
            <div>
              <button
                onClick={() => {
                  setPane2Txt(
                    JSON.stringify(
                      zone,
                      (key, val) => {
                        if (key == 'generators') return false;
                        else return val;
                      },
                      2
                    )
                  );
                  start(
                    `/sample/${zone.keyRange.lo}/${zone.velRange.hi}`,
                    (update) => setDetails(update)
                  );
                }}
              >
                details
              </button>
            </div>
          </div>
        );
      }
      function ZoneList({ list, zones }) {
        const [zoneList, setZoneList] = React.useState([]);
        const [pane2Txt, setPane2Txt] = React.useState('');

        return (
          <div className="row">
            <span className="col-md-3">
              {list.map((item, idx) => (
                <li key={idx} name={item.name}>
                  <a
                    onClick={() =>
                      fetch(`/presets/${idx}`)
                        .then((res) => res.json())
                        .then((arr) => setZoneList(arr))
                    }
                    href={`#${item.presetId}`}
                  >
                    (123)
                  </a>
                  {item.name}
                </li>
              ))}
            </span>
            <span id="col2" className="col-md-3">
              <ul id="l2">
                {zoneList.map((z, i) => (
                  <ZoneUI key={i} setPane2Txt={setPane2Txt} zone={z} />
                ))}
              </ul>
            </span>
            <span id="col1" className="col-md-3">
              <pre className="sticky">{pane2Txt}</pre>
            </span>
          </div>
        );
      }
    </script>
    <script type="module">
      let sff;
      function showerror(e) {
        document.write(e.message);
      }
      const [sfselect, midselect] = document.body.querySelectorAll('select');
      const lists = document.querySelectorAll('ul');

      fetch('/lists', { headers: { accept: 'application/json' } })
        .then((res) => res.json())
        .then(({ mfiles, pdta: { phdr } }) => {
          const list = phdr.filter((item) => item.bankId == 0);
          ReactDOM.render(
            React.createElement(ZoneList, { list }),
            document.querySelector('#root')
          );
        });
    </script>

    <footer>
      <div class="col-sm col-lg-10 col-lg-offset-1">
        <p>
          Copyright &copy; Your Website 2017 | Built using
          <a href="https://chalarangelo.github.io/mini.css/">mini.css</a>
        </p>
      </div>
    </footer>
    <span class="material-icons">face</span>

    <div id="prerend" class="hidden"></div>
  </body>
</html>
