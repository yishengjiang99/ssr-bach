<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>

 function sfbkstream(url) {
    const ab = await (await fetch(url, { headers: { Range: 'bytes=0-6400' } })).arrayBuffer();
    const [preample, r] = skipToSDTA(ab);
    const sdtaSize = r.get32();
    const stdstart = r.offset + 8;
    const pdtastart = stdstart + sdtaSize + 4;
    const rangeHeader = {
        headers: {
            Range: 'bytes=' + stdstart + '-' + pdtastart,
        },
    };
    const pdtaHeader = {
        headers: { Range: 'bytes=' + pdtastart + '-' },
    };
    const { readable, writable } = new TransformStream();
    (await fetch(url, rangeHeader)).body.pipeTo(writable);
    return {
        nsamples: (pdtastart - stdstart) / 2,
        sdtaStream: readable,
        infos: preample,
        pdtaBuffer: new Uint8Array(await (await fetch(url, pdtaHeader)).arrayBuffer()),
    };
}
function skipToSDTA(ab) {
    const infosection = new Uint8Array(ab);
    const r = readAB(infosection);
    const [riff, filesize, sig, list] = [
        r.readNString(4),
        r.get32(),
        r.readNString(4),
        r.readNString(4),
    ];
    console.assert(riff == 'RIFF' && sig == 'sfbk');
    let infosize = r.get32();
    console.log(r.readNString(4), filesize, list, r.offset);
    console.log(infosize, r.offset);
    const infos = [];
    while (infosize >= 8) {
        const [section, size] = [r.readNString(4), r.get32()];
        infos.push({ section, text: r.readNString(size) });
        infosize = infosize - 8 - size;
    }
    console.assert(r.readNString(4) == 'LIST');
    return [infos, r];
}
var Module={onRuntimeInitialized:function(){
				resolve();
			}};
const { pdtaBuffer, sdtaStream, nsamples, infos } = await sfbkstream("sm.sf2");	
			window.pdtaBuffer=pdtaBuffer;
      window.wasmloaded=new Promise(resolve=>{
			var Module={onRuntimeInitialized:function(){
				resolve();
			}};
		});

			window.wasmloaded;
			const a=Module._malloc(pdtaBuffer.byteLength);
			Module.HEAPU8.set(pdtaBuffer,a);
			Module.ccall("loadpdta", null, ["number"], [a],null);
			console.time("s");
			let z;
			for(let i=0;i<128;i++){
				const pptr=Module.ccall("findByPid", "number", ["number","number"], [2, 0],null);
				const zptr=	Module.ccall("filterForZone","number",["number","number","number"],[pptr,66, i],null);
				z =Module.HEAP16.subarray(zptr/2, zptr/2+60);
			}
  </script>
  	<script  async src='pdta.js'></script>

</body>
</html>